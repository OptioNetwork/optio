name: Build Multi-Platform Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub release'
        required: false
        default: 'true'
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            name: optio-linux
          - goos: darwin
            goarch: arm64
            name: optio-darwin-arm64
          - goos: darwin
            goarch: amd64
            name: optio-darwin-amd64
          - goos: windows
            goarch: amd64
            name: optio-windows.exe
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for git describe

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23.6'
        cache: true

    - name: Install dependencies
      run: |
        go mod download
        go mod verify

    - name: Build ${{ matrix.goos }}-${{ matrix.goarch }} binary
      env:
        VERSION: ${{ github.event.inputs.version || '1.0.0' }}
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        COMMIT=$(git rev-parse --short HEAD)
        go build \
          -ldflags "-s -w -X github.com/cosmos/cosmos-sdk/version.Version=v$VERSION -X github.com/cosmos/cosmos-sdk/version.Commit=$COMMIT -X github.com/cosmos/cosmos-sdk/version.AppName=optiod -X github.com/cosmos/cosmos-sdk/version.Name=Optio -X github.com/cosmos/cosmos-sdk/version.BuildTags=${{ matrix.goos }},${{ matrix.goarch }}" \
          -o build/${{ matrix.name }} \
          ./cmd/optiod
        ls -la build/

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-${{ github.event.inputs.version || '1.0.0' }}
        path: build/${{ matrix.name }}
        retention-days: 30

    - name: Show binary info
      if: matrix.goos == 'linux'
      run: |
        echo "Binary size:"
        ls -lh build/${{ matrix.name }}
        echo "Binary version info:"
        ./build/${{ matrix.name }} version

  release:
    needs: build
    if: github.event.inputs.create_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release files
      run: |
        mkdir -p release
        cp artifacts/optio-linux-${{ github.event.inputs.version || '1.0.0' }}/optio-linux release/
        cp artifacts/optio-darwin-arm64-${{ github.event.inputs.version || '1.0.0' }}/optio-darwin-arm64 release/
        cp artifacts/optio-darwin-amd64-${{ github.event.inputs.version || '1.0.0' }}/optio-darwin-amd64 release/
        cp artifacts/optio-windows.exe-${{ github.event.inputs.version || '1.0.0' }}/optio-windows.exe release/
        ls -la release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.event.inputs.version || '1.0.0' }}
        name: v${{ github.event.inputs.version || '1.0.0' }}
        body: |
          ## v${{ github.event.inputs.version || '1.0.0' }}
          
          ### Downloads
          - **Linux (x86_64)**: `optio-linux`
          - **macOS (Apple Silicon)**: `optio-darwin-arm64`
          - **macOS (Intel)**: `optio-darwin-amd64`
          - **Windows (x86_64)**: `optio-windows.exe`
          
          ### Installation
          
          #### Linux/macOS
          ```bash
          # Download the appropriate binary for your platform
          # Make it executable
          chmod +x optio-*
          
          # Move to your PATH
          sudo mv optio-* /usr/local/bin/optiod
          ```
          
          #### Windows
          ```powershell
          # Download optio-windows.exe
          # Rename and move to a directory in your PATH
          ```
          
          ### Version Info
          Built with Go 1.23.6
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          release/optio-linux
          release/optio-darwin-arm64
          release/optio-darwin-amd64
          release/optio-windows.exe
        token: ${{ secrets.GITHUB_TOKEN }}
